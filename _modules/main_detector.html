<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>main_detector &mdash; fast_rboost_bins 1.0.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            fast_rboost_bins
          </a>
              <div class="version">
                1.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">fast_rboost_bins</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">main_detector</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for main_detector</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Auxiliary script with command-line user interface for training and testing object detectors based on ``FastRealBoostBins`` classifier from :doc:`frbb`.</span>

<span class="sd">For help on the script arguments execute:</span>

<span class="sd">.. code-block:: console</span>

<span class="sd">    python main_detector.py -h </span>

<span class="sd">For usage examples, see the README.md file in project&#39;s repository (`&lt;https://github.com/pklesk/fast_rboost_bins&gt;`_).</span>

<span class="sd">Dependencies</span>
<span class="sd">------------</span>
<span class="sd">- ``frbb``: required to import the class ``FastRealBoostBins``.</span>

<span class="sd">- ``numpy``, ``math``: required for mathematical computations.</span>

<span class="sd">- ``numba``: required for just-in-time compilation of crucial computational functions and CUDA kernels (decorated by ``@jit`` and ``@cuda.jit`` imported from ``numba``). </span>

<span class="sd">- ``sklearn``: required for inheritence and other sklearn API purposes,</span>

<span class="sd">- ``colorama``: required for CLI purposes,</span>

<span class="sd">- ``cv2``: required for video capturing,</span>

<span class="sd">- ``joblib``: required for comparisons: CPU with parallelization vs GPU.</span>

<span class="sd">Link to project repository</span>
<span class="sd">--------------------------</span>
<span class="sd">`https://github.com/pklesk/fast_rboost_bins &lt;https://github.com/pklesk/fast_rboost_bins&gt;`_</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">frbb</span> <span class="kn">import</span> <span class="n">FastRealBoostBins</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">cuda</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">haar</span>
<span class="kn">import</span> <span class="nn">datagenerator</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_curve</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">cpu_and_system_props</span><span class="p">,</span> <span class="n">gpu_props</span><span class="p">,</span> <span class="n">dict_to_str</span><span class="p">,</span> <span class="n">pickle_objects</span><span class="p">,</span> <span class="n">unpickle_objects</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">colorama</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Przemysław Klęsk&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;pklesk@zut.edu.pl&quot;</span>

<span class="c1"># main settings</span>
<span class="n">KIND</span> <span class="o">=</span> <span class="s2">&quot;face&quot;</span> <span class="c1"># choices: {&quot;face&quot;, &quot;hand&quot;}</span>
<span class="n">S</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># parameter &quot;scales&quot; to generete Haar-like features</span>
<span class="n">P</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># parameter &quot;positions&quot; to generete Haar-like features</span>
<span class="n">NPI</span> <span class="o">=</span> <span class="mi">300</span> <span class="c1"># &quot;negatives per image&quot; - no. of negatives (negative windows) to sample per image (image real or generated synthetically) </span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">1024</span> <span class="c1"># size of ensemble in FastRealBoostBins (equivalently, no. of boosting rounds when fitting)</span>
<span class="n">B</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># no. of bins</span>
<span class="n">SEED</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># randomization seed</span>
<span class="n">DEMO_HAAR_FEATURES_ALL</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DEMO_HAAR_FEATURES_SELECTED</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">REGENERATE_DATA</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">FIT_OR_REFIT_MODEL</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">MEASURE_ACCS_OF_MODEL</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">ADJUST_DECISION_THRESHOLD_OF_MODEL</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DEMO_DETECT_IN_VIDEO</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DEMO_DETECT_IN_VIDEO_COMPUTATIONS</span> <span class="o">=</span> <span class="s2">&quot;gpu_cuda&quot;</span> <span class="c1"># choices: {&quot;cpu_simple&quot;, &quot;cpu_parallel&quot;, &quot;gpu_cuda&quot;}</span>
<span class="n">DEMO_DETECT_IN_VIDEO_PARALLEL_JOBS</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">DEMO_DETECT_IN_VIDEO_VERBOSE_LOOP</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DEMO_DETECT_IN_VIDEO_VERBOSE_DETECT</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DEMO_DETECT_IN_VIDEO_FRAMES</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># if not None but integer then detection is stopped after seeing given number of frames</span>
<span class="n">DEMO_DETECT_IN_VIDEO_MULTIPLE_CLFS</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># cv2 camera settings</span>
<span class="n">CV2_VIDEO_CAPTURE_CAMERA_INDEX</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">CV2_VIDEO_CAPTURE_OS_IS_MSWINDOWS</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">CV2_VIDEO_CAPTURE_NO_FLIP</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># detection procedure settings</span>
<span class="n">DETECTION_SCALES</span> <span class="o">=</span> <span class="mi">9</span> <span class="c1"># 9 (lighter), 12 (heavier)</span>
<span class="n">DETECTION_WINDOW_HEIGHT_MIN</span> <span class="o">=</span> <span class="mi">96</span> <span class="c1"># 96 (lighter), 64 (heavier) </span>
<span class="n">DETECTION_WINDOW_WIDTH_MIN</span> <span class="o">=</span> <span class="mi">96</span> <span class="c1"># 96 (lighter), 64 (heavier)</span>
<span class="n">DETECTION_WINDOW_GROWTH</span> <span class="o">=</span> <span class="mf">1.2</span>
<span class="n">DETECTION_WINDOW_JUMP</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">DETECTION_DECISION_THRESHOLD</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># can be set to None (then classfier&#39;s internal threshold is used)</span>
<span class="n">DETECTION_POSTPROCESS</span> <span class="o">=</span> <span class="s2">&quot;avg&quot;</span> <span class="c1"># choices: {None, &quot;avg&quot;, &quot;nms&quot;}</span>

<span class="c1"># settings for detection with multiple classifiers (special option)</span>
<span class="n">MC_CLFS_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;clf_frbb_face_n_18225_S_5_P_5_NPI_300_SEED_0_T_1024_B_8.bin&quot;</span><span class="p">,</span> <span class="s2">&quot;clf_frbb_hand_n_18225_S_5_P_5_NPI_30_SEED_0_T_1024_B_8.bin&quot;</span><span class="p">]</span>
<span class="n">MC_DECISION_THRESHOLDS</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

<span class="c1"># folders</span>
<span class="n">FOLDER_DATA</span> <span class="o">=</span> <span class="s2">&quot;../data/&quot;</span>
<span class="n">FOLDER_CLFS</span> <span class="o">=</span> <span class="s2">&quot;../models/&quot;</span>
<span class="n">FOLDER_EXTRAS</span> <span class="o">=</span> <span class="s2">&quot;../extras/&quot;</span>
                            
<div class="viewcode-block" id="measure_accs_of_model"><a class="viewcode-back" href="../main_detector.html#main_detector.measure_accs_of_model">[docs]</a><span class="k">def</span> <span class="nf">measure_accs_of_model</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Measures and prints accuracies of a model (classifier) for given train and test data.&quot;&quot;&quot;</span> 
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MEASURE ACCS OF MODEL...&quot;</span><span class="p">)</span>
    <span class="n">t1_accs</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>    
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">acc_train</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[train acc: </span><span class="si">{</span><span class="n">acc_train</span><span class="si">}</span><span class="s2">; data shape: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, time: </span><span class="si">{</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="n">ind_pos</span> <span class="o">=</span> <span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">X_train_pos</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
    <span class="n">y_train_pos</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>    
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">sens_train</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train_pos</span><span class="p">,</span> <span class="n">y_train_pos</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[train sensitivity: </span><span class="si">{</span><span class="n">sens_train</span><span class="si">}</span><span class="s2">; data shape: </span><span class="si">{</span><span class="n">X_train_pos</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, time: </span><span class="si">{</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="n">ind_neg</span> <span class="o">=</span> <span class="n">y_train</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">X_train_neg</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
    <span class="n">y_train_neg</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>    
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">far_train</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train_neg</span><span class="p">,</span> <span class="n">y_train_neg</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[train far: </span><span class="si">{</span><span class="n">far_train</span><span class="si">}</span><span class="s2">; data shape: </span><span class="si">{</span><span class="n">X_train_neg</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, time: </span><span class="si">{</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">acc_test</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[test acc: </span><span class="si">{</span><span class="n">acc_test</span><span class="si">}</span><span class="s2">; data shape: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, time: </span><span class="si">{</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="n">ind_pos</span> <span class="o">=</span> <span class="n">y_test</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">X_test_pos</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
    <span class="n">y_test_pos</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>    
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">sens_test</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_pos</span><span class="p">,</span> <span class="n">y_test_pos</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[test sensitivity: </span><span class="si">{</span><span class="n">sens_test</span><span class="si">}</span><span class="s2">; data shape: </span><span class="si">{</span><span class="n">X_test_pos</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, time: </span><span class="si">{</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="n">ind_neg</span> <span class="o">=</span> <span class="n">y_test</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">X_test_neg</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
    <span class="n">y_test_neg</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>    
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">far_test</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_neg</span><span class="p">,</span> <span class="n">y_test_neg</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[test far: </span><span class="si">{</span><span class="n">far_test</span><span class="si">}</span><span class="s2">; data shape: </span><span class="si">{</span><span class="n">X_test_neg</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, time: </span><span class="si">{</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="n">t2_accs</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MEASURE ACCS DONE. [time: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t2_accs</span> <span class="o">-</span> <span class="n">t1_accs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; s]&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="best_decision_threshold_via_precision"><a class="viewcode-back" href="../main_detector.html#main_detector.best_decision_threshold_via_precision">[docs]</a><span class="k">def</span> <span class="nf">best_decision_threshold_via_precision</span><span class="p">(</span><span class="n">roc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">heuristic_coeff</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns `the best` decision threshold that maximizes (approximately) the precision measure for test data (by analyzing its ROC curve).&quot;&quot;&quot;</span>
    <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">py</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_test</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">py</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">fprs</span><span class="p">,</span> <span class="n">tprs</span><span class="p">,</span> <span class="n">dts</span> <span class="o">=</span> <span class="n">roc</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">fprs</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
    <span class="n">fprs_sub</span> <span class="o">=</span> <span class="n">fprs</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span>
    <span class="n">tprs_sub</span> <span class="o">=</span> <span class="n">tprs</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span>
    <span class="n">dts_sub</span> <span class="o">=</span> <span class="n">dts</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">tprs_sub</span> <span class="o">*</span> <span class="n">py</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">fprs_sub</span> <span class="o">*</span> <span class="n">py</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">precs</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span>
    <span class="n">best_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">precs</span><span class="p">)</span>
    <span class="n">best_thr</span> <span class="o">=</span> <span class="n">dts_sub</span><span class="p">[</span><span class="n">best_index</span><span class="p">]</span>
    <span class="n">best_prec</span> <span class="o">=</span> <span class="n">precs</span><span class="p">[</span><span class="n">best_index</span><span class="p">]</span>    
    <span class="k">if</span> <span class="n">best_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">best_thr</span> <span class="o">=</span> <span class="n">heuristic_coeff</span> <span class="o">*</span> <span class="n">best_thr</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">heuristic_coeff</span><span class="p">)</span> <span class="o">*</span> <span class="n">dts_sub</span><span class="p">[</span><span class="n">best_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> 
        <span class="n">best_prec</span> <span class="o">=</span> <span class="n">heuristic_coeff</span> <span class="o">*</span> <span class="n">best_prec</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">heuristic_coeff</span><span class="p">)</span> <span class="o">*</span> <span class="n">precs</span><span class="p">[</span><span class="n">best_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[best_decision_threshold_via_precision (heuristic_coeff: </span><span class="si">{</span><span class="n">heuristic_coeff</span><span class="si">}</span><span class="s2">) -&gt; best_thr: </span><span class="si">{</span><span class="n">best_thr</span><span class="si">}</span><span class="s2">, best_prec: </span><span class="si">{</span><span class="n">best_prec</span><span class="si">}</span><span class="s2">; py: </span><span class="si">{</span><span class="n">py</span><span class="si">}</span><span class="s2">, best_index on roc: </span><span class="si">{</span><span class="n">best_index</span><span class="si">}</span><span class="s2">, fprs_sub[best_index]: </span><span class="si">{</span><span class="n">fprs_sub</span><span class="p">[</span><span class="n">best_index</span><span class="p">]</span><span class="si">}</span><span class="s2">, tprs_sub[best_index]: </span><span class="si">{</span><span class="n">tprs_sub</span><span class="p">[</span><span class="n">best_index</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">best_thr</span><span class="p">,</span> <span class="n">best_prec</span></div>

<div class="viewcode-block" id="adjust_decision_threshold_via_precision"><a class="viewcode-back" href="../main_detector.html#main_detector.adjust_decision_threshold_via_precision">[docs]</a><span class="k">def</span> <span class="nf">adjust_decision_threshold_via_precision</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">heuristic_coeff</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Replaces the ``clf.decision_threshold_`` value in a classifier by determining the threshold that maximizes (approximately) the precision measure for test data (by analyzing its ROC curve).&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ADJUST DECISION THRESHOLD VIA PRECISION...&quot;</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">responses_test</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">roc</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">responses_test</span><span class="p">)</span>
    <span class="n">best_thr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">best_decision_threshold_via_precision</span><span class="p">(</span><span class="n">roc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">heuristic_coeff</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[adjusting decision threshold within clf from </span><span class="si">{</span><span class="n">clf</span><span class="o">.</span><span class="n">decision_threshold_</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">best_thr</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">decision_threshold_</span> <span class="o">=</span> <span class="n">best_thr</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ADJUST DECISION THRESHOLD VIA PRECISION DONE. [time: </span><span class="si">{</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="si">}</span><span class="s2"> s] &quot;</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="draw_feature_at"><a class="viewcode-back" href="../main_detector.html#main_detector.draw_feature_at">[docs]</a><span class="k">def</span> <span class="nf">draw_feature_at</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">shcoords_one_feature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Draws a Haar-like feature on top of an image (with transparency) at a given position.&quot;&quot;&quot;</span>
    <span class="n">i_copy</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">shcoords_one_feature</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">i_copy</span><span class="p">,</span> <span class="p">(</span><span class="n">k0</span> <span class="o">+</span> <span class="n">k</span><span class="p">,</span> <span class="n">j0</span> <span class="o">+</span> <span class="n">j</span><span class="p">),</span> <span class="p">(</span><span class="n">k0</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j0</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FILLED</span><span class="p">)</span>
    <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">shcoords_one_feature</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">i_copy</span><span class="p">,</span> <span class="p">(</span><span class="n">k0</span> <span class="o">+</span> <span class="n">k</span><span class="p">,</span> <span class="n">j0</span> <span class="o">+</span> <span class="n">j</span><span class="p">),</span> <span class="p">(</span><span class="n">k0</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j0</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FILLED</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">i_copy</span></div>

<div class="viewcode-block" id="demo_haar_features"><a class="viewcode-back" href="../main_detector.html#main_detector.demo_haar_features">[docs]</a><span class="k">def</span> <span class="nf">demo_haar_features</span><span class="p">(</span><span class="n">hinds</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">selected_indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performs a demonstration of Haar-like features (all or selected by specified indexes) by sequentially drawing them on top of a prepared image (with a face or hand gesture).&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEMO OF HAAR FEATURES... [hcoords.shape: </span><span class="si">{</span><span class="n">hcoords</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[with focus placed on display window press &#39;esc&#39; to quit or any other key to continue]&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">KIND</span> <span class="o">==</span> <span class="s2">&quot;face&quot;</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">FOLDER_EXTRAS</span> <span class="o">+</span> <span class="s2">&quot;photo_for_face_features_demo.jpg&quot;</span><span class="p">)</span>
        <span class="n">j0</span><span class="p">,</span> <span class="n">k0</span> <span class="o">=</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">88</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">251</span>
    <span class="k">elif</span> <span class="n">KIND</span> <span class="o">==</span> <span class="s2">&quot;hand&quot;</span><span class="p">:</span> 
        <span class="n">i</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">FOLDER_EXTRAS</span> <span class="o">+</span> <span class="s2">&quot;photo_for_hand_features_demo.jpg&quot;</span><span class="p">)</span>
        <span class="n">j0</span><span class="p">,</span> <span class="n">k0</span> <span class="o">=</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">53</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">257</span>
    <span class="n">i_resized</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">resize_image</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">i_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">i_resized</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">integral_image_numba_jit</span><span class="p">(</span><span class="n">i_gray</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">i_resized</span><span class="p">,</span> <span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">j0</span><span class="p">),</span> <span class="p">(</span><span class="n">k0</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j0</span> <span class="o">+</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;[&#39;esc&#39; to quit or other to continue]&quot;</span>    
    <span class="n">font_size</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">text_shift</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">font_size</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">color_info</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">i_resized</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;DEMO OF FEATURES [KIND: </span><span class="si">{</span><span class="n">KIND</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">text_shift</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>        
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">i_resized</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">()</span>    
    <span class="k">if</span> <span class="n">selected_indexes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">selected_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ord_ind</span> <span class="ow">in</span> <span class="n">selected_indexes</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">hinds</span><span class="p">[</span><span class="n">ord_ind</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">hcoords</span><span class="p">[</span><span class="n">ord_ind</span><span class="p">]</span>
        <span class="n">hcoords_window</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span> 
        <span class="n">i_with_feature</span> <span class="o">=</span> <span class="n">draw_feature_at</span><span class="p">(</span><span class="n">i_resized</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">hcoords_window</span><span class="p">)</span>
        <span class="n">i_temp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">i_resized</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="n">i_with_feature</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">feature_value</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">haar_feature_numba_jit</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">hcoords_window</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[feature index (ordinal): </span><span class="si">{</span><span class="n">ord_ind</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[feature multi-index: </span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[feature hcoords (cartesian):</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[feature hcoords in window:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">hcoords_window</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[feature value: </span><span class="si">{</span><span class="n">feature_value</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">160</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">i_temp</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="mi">27</span><span class="p">:</span> <span class="c1"># esc key</span>
            <span class="k">break</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
    <span class="n">hcoords_window_subset</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span> <span class="o">*</span> <span class="n">hcoords</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span> 
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">haar_features_one_window_numba_jit</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">hcoords_window_subset</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[time of extraction of all </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> haar features for this window (in one call): </span><span class="si">{</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[features: </span><span class="si">{</span><span class="n">features</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span> 
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEMO OF HAAR FEATURES DONE.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="prepare_detection_windows_and_scaled_haar_coords"><a class="viewcode-back" href="../main_detector.html#main_detector.prepare_detection_windows_and_scaled_haar_coords">[docs]</a><span class="k">def</span> <span class="nf">prepare_detection_windows_and_scaled_haar_coords</span><span class="p">(</span><span class="n">image_height</span><span class="p">,</span> <span class="n">image_width</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">features_indexes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepares and returns coordinates of all windows (two-dimensional array) to be checked during a detection procedure together with relative and scaled pixel coordinates of Haar-like features (four-dimensional array).&quot;&quot;&quot;</span>
    <span class="n">hcoords_subset</span> <span class="o">=</span> <span class="n">hcoords</span><span class="p">[</span><span class="n">features_indexes</span><span class="p">]</span>
    <span class="n">windows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">shcoords_multiple_scales</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">DETECTION_SCALES</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">DETECTION_WINDOW_HEIGHT_MIN</span> <span class="o">*</span> <span class="n">DETECTION_WINDOW_GROWTH</span><span class="o">**</span><span class="n">s</span><span class="p">))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">DETECTION_WINDOW_WIDTH_MIN</span> <span class="o">*</span> <span class="n">DETECTION_WINDOW_GROWTH</span><span class="o">**</span><span class="n">s</span><span class="p">))</span>        
        <span class="n">dj</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">DETECTION_WINDOW_JUMP</span><span class="p">))</span>
        <span class="n">dk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">DETECTION_WINDOW_JUMP</span><span class="p">))</span>     
        <span class="n">j_start</span> <span class="o">=</span> <span class="p">((</span><span class="n">image_height</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">%</span> <span class="n">dj</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">k_start</span> <span class="o">=</span> <span class="p">((</span><span class="n">image_width</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">%</span> <span class="n">dk</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">shcoords_multiple_scales</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span> <span class="o">*</span> <span class="n">hcoords_subset</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j_start</span><span class="p">,</span> <span class="n">image_height</span> <span class="o">-</span> <span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dj</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_start</span><span class="p">,</span> <span class="n">image_width</span> <span class="o">-</span> <span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dk</span><span class="p">):</span>
                <span class="n">windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">))</span>
    <span class="n">windows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span> 
    <span class="n">shcoords_multiple_scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shcoords_multiple_scales</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">windows</span><span class="p">,</span> <span class="n">shcoords_multiple_scales</span></div>

<div class="viewcode-block" id="prepare_detection_windows"><a class="viewcode-back" href="../main_detector.html#main_detector.prepare_detection_windows">[docs]</a><span class="k">def</span> <span class="nf">prepare_detection_windows</span><span class="p">(</span><span class="n">image_height</span><span class="p">,</span> <span class="n">image_width</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepares and returns coordinates of all windows (two-dimensional array) to be checked during a detection procedure.&quot;&quot;&quot;</span>
    <span class="n">windows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">DETECTION_SCALES</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">DETECTION_WINDOW_HEIGHT_MIN</span> <span class="o">*</span> <span class="n">DETECTION_WINDOW_GROWTH</span><span class="o">**</span><span class="n">s</span><span class="p">))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">DETECTION_WINDOW_WIDTH_MIN</span> <span class="o">*</span> <span class="n">DETECTION_WINDOW_GROWTH</span><span class="o">**</span><span class="n">s</span><span class="p">))</span>        
        <span class="n">dj</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">DETECTION_WINDOW_JUMP</span><span class="p">))</span>
        <span class="n">dk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">DETECTION_WINDOW_JUMP</span><span class="p">))</span>     
        <span class="n">j_start</span> <span class="o">=</span> <span class="p">((</span><span class="n">image_height</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">%</span> <span class="n">dj</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">k_start</span> <span class="o">=</span> <span class="p">((</span><span class="n">image_width</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">%</span> <span class="n">dk</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">j0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j_start</span><span class="p">,</span> <span class="n">image_height</span> <span class="o">-</span> <span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dj</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_start</span><span class="p">,</span> <span class="n">image_width</span> <span class="o">-</span> <span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dk</span><span class="p">):</span>
                <span class="n">windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">))</span>
    <span class="n">windows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span>  
    <span class="k">return</span> <span class="n">windows</span></div>

<div class="viewcode-block" id="prepare_scaled_haar_coords"><a class="viewcode-back" href="../main_detector.html#main_detector.prepare_scaled_haar_coords">[docs]</a><span class="k">def</span> <span class="nf">prepare_scaled_haar_coords</span><span class="p">(</span><span class="n">hcoords</span><span class="p">,</span> <span class="n">features_indexes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepares and returns relative and scaled pixel coordinates of Haar-like features (four-dimensional array) suitable for a detection procedure.&quot;&quot;&quot;</span>
    <span class="n">hcoords_subset</span> <span class="o">=</span> <span class="n">hcoords</span><span class="p">[</span><span class="n">features_indexes</span><span class="p">]</span>
    <span class="n">shcoords_multiple_scales</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">DETECTION_SCALES</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">DETECTION_WINDOW_HEIGHT_MIN</span> <span class="o">*</span> <span class="n">DETECTION_WINDOW_GROWTH</span><span class="o">**</span><span class="n">s</span><span class="p">))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">DETECTION_WINDOW_WIDTH_MIN</span> <span class="o">*</span> <span class="n">DETECTION_WINDOW_GROWTH</span><span class="o">**</span><span class="n">s</span><span class="p">))</span>        
        <span class="n">shcoords_multiple_scales</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span> <span class="o">*</span> <span class="n">hcoords_subset</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">))</span>
    <span class="n">shcoords_multiple_scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shcoords_multiple_scales</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">shcoords_multiple_scales</span></div>

<div class="viewcode-block" id="detect_cpu_simple"><a class="viewcode-back" href="../main_detector.html#main_detector.detect_cpu_simple">[docs]</a><span class="k">def</span> <span class="nf">detect_cpu_simple</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">clf</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">features_indexes</span><span class="p">,</span> <span class="n">decision_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">windows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shcoords_multiple_scales</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs detection on an image frame in the `cpu_simple` mode (i.e. with no CPU parallelization, nor GPU usage).</span>
<span class="sd">    Called for each frame from within the ``demo_detect_in_video`` function.</span>
<span class="sd">    &quot;&quot;&quot;</span>  
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[detect_cpu_simple...]&quot;</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">t1_preprocess</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">i_resized</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">resize_image</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">i_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">i_resized</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">i_h</span><span class="p">,</span> <span class="n">i_w</span> <span class="o">=</span> <span class="n">i_gray</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">t2_preprocess</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_preprocess</span> <span class="o">=</span> <span class="n">t2_preprocess</span> <span class="o">-</span> <span class="n">t1_preprocess</span>
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;preprocess&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_preprocess</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_cpu_simple: preprocessing done; time: </span><span class="si">{</span><span class="n">dt_preprocess</span><span class="si">}</span><span class="s2"> s, i_gray.shape: </span><span class="si">{</span><span class="n">i_gray</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="n">t1_ii</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">integral_image_numba_jit</span><span class="p">(</span><span class="n">i_gray</span><span class="p">)</span>
    <span class="n">t2_ii</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_ii</span> <span class="o">=</span> <span class="n">t2_ii</span> <span class="o">-</span> <span class="n">t1_ii</span>
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;ii&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_ii</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_cpu_simple: integral_image_numba_jit done; time: </span><span class="si">{</span><span class="n">dt_ii</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">windows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t1_prepare</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">windows</span><span class="p">,</span> <span class="n">shcoords_multiple_scales</span> <span class="o">=</span> <span class="n">prepare_detection_windows_and_scaled_haar_coords</span><span class="p">(</span><span class="n">i_h</span><span class="p">,</span> <span class="n">i_w</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">features_indexes</span><span class="p">)</span>
        <span class="n">t2_prepare</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">dt_prepare</span> <span class="o">=</span> <span class="n">t2_prepare</span> <span class="o">-</span> <span class="n">t1_prepare</span>
        <span class="n">times</span><span class="p">[</span><span class="s2">&quot;prepare&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_prepare</span>    
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_cpu_simple: prepare_detection_windows_and_scaled_haar_coords done; time: </span><span class="si">{</span><span class="n">dt_prepare</span><span class="si">}</span><span class="s2"> s, windows to check: </span><span class="si">{</span><span class="n">windows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="n">t1_haar</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>    
    <span class="n">X</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">haar_features_multiple_windows_numba_jit</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">windows</span><span class="p">,</span> <span class="n">shcoords_multiple_scales</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">features_indexes</span><span class="p">)</span>
    <span class="n">t2_haar</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_haar</span> <span class="o">=</span> <span class="n">t2_haar</span> <span class="o">-</span> <span class="n">t1_haar</span>
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;haar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_haar</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_cpu_simple: haar_features_multiple_windows done; time: </span><span class="si">{</span><span class="n">dt_haar</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="n">t1_frbb</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>    
    <span class="n">responses</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">_decision_function_numba_jit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">t2_frbb</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_frbb</span> <span class="o">=</span> <span class="n">t2_frbb</span> <span class="o">-</span> <span class="n">t1_frbb</span> 
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;frbb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_frbb</span> 
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_cpu_simple: clf._decision_function done; time: </span><span class="si">{</span><span class="n">dt_frbb</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="n">t1_ti</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">decision_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">decision_threshold</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">decision_threshold_</span>             
    <span class="n">detected</span> <span class="o">=</span> <span class="n">responses</span> <span class="o">&gt;</span> <span class="n">decision_threshold</span>
    <span class="n">detections</span> <span class="o">=</span> <span class="n">windows</span><span class="p">[</span><span class="n">detected</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="c1"># skipping scale index</span>
    <span class="n">responses</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="n">detected</span><span class="p">]</span> 
    <span class="n">t2_ti</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_ti</span> <span class="o">=</span> <span class="n">t2_ti</span> <span class="o">-</span> <span class="n">t1_ti</span>
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;ti&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_ti</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_cpu_simple: finding detections (thresholding and indexing) done; time: </span><span class="si">{</span><span class="n">dt_ti</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>        
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_cpu_simple done; time: </span><span class="si">{</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>                    
    <span class="k">return</span> <span class="n">detections</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">times</span></div>

<div class="viewcode-block" id="detect_cpu_parallel"><a class="viewcode-back" href="../main_detector.html#main_detector.detect_cpu_parallel">[docs]</a><span class="k">def</span> <span class="nf">detect_cpu_parallel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">clf</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">features_indexes</span><span class="p">,</span> <span class="n">decision_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">windows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shcoords_multiple_scales</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs detection on an image frame in the `cpu_parallel` mode (i.e. with CPU parallelization via ``joblib.Parallel`` object, but with no GPU usage).</span>
<span class="sd">    Called for each frame from within the ``demo_detect_in_video`` function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[detect_cpu_parallel...]&quot;</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">t1_preprocess</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">i_resized</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">resize_image</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">i_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">i_resized</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">i_h</span><span class="p">,</span> <span class="n">i_w</span> <span class="o">=</span> <span class="n">i_gray</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">t2_preprocess</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_preprocess</span> <span class="o">=</span> <span class="n">t2_preprocess</span> <span class="o">-</span> <span class="n">t1_preprocess</span>
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;preprocess&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_preprocess</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_cpu_parallel: preprocessing done; time: </span><span class="si">{</span><span class="n">dt_preprocess</span><span class="si">}</span><span class="s2"> s; i_gray.shape: </span><span class="si">{</span><span class="n">i_gray</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="n">t1_ii</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">integral_image_numba_jit</span><span class="p">(</span><span class="n">i_gray</span><span class="p">)</span>
    <span class="n">t2_ii</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_ii</span> <span class="o">=</span> <span class="n">t2_ii</span> <span class="o">-</span> <span class="n">t1_ii</span>
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;ii&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_ii</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_cpu_parallel: integral_image_numba_jit done; time: </span><span class="si">{</span><span class="n">dt_ii</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">windows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t1_prepare</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">windows</span><span class="p">,</span> <span class="n">shcoords_multiple_scales</span> <span class="o">=</span> <span class="n">prepare_detection_windows_and_scaled_haar_coords</span><span class="p">(</span><span class="n">i_h</span><span class="p">,</span> <span class="n">i_w</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">features_indexes</span><span class="p">)</span>
        <span class="n">t2_prepare</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">dt_prepare</span> <span class="o">=</span> <span class="n">t2_prepare</span> <span class="o">-</span> <span class="n">t1_prepare</span>
        <span class="n">times</span><span class="p">[</span><span class="s2">&quot;prepare&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_prepare</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_cpu_parallel: prepare_detection_windows_and_scaled_haar_coords done; time: </span><span class="si">{</span><span class="n">dt_prepare</span><span class="si">}</span><span class="s2"> s; windows to check: </span><span class="si">{</span><span class="n">windows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>    
    <span class="n">t1_parallel</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">windows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_calls</span> <span class="o">=</span> <span class="n">n_jobs</span> <span class="o">*</span> <span class="mi">1</span>
    <span class="n">job_size</span> <span class="o">=</span> <span class="n">m</span> <span class="o">//</span> <span class="n">n_calls</span>
    <span class="n">job_ranges</span> <span class="o">=</span> <span class="n">job_size</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_calls</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>        
    <span class="n">job_ranges</span><span class="p">[:</span><span class="n">m</span> <span class="o">%</span> <span class="n">n_calls</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">job_ranges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">job_ranges</span><span class="p">)]</span>                    
    <span class="k">with</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">parallel</span><span class="p">:</span>      
        <span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">job_index</span><span class="p">):</span>
            <span class="n">job_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">job_ranges</span><span class="p">[</span><span class="n">job_index</span><span class="p">],</span> <span class="n">job_ranges</span><span class="p">[</span><span class="n">job_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">job_windows</span> <span class="o">=</span> <span class="n">windows</span><span class="p">[</span><span class="n">job_slice</span><span class="p">]</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">haar_features_multiple_windows_numba_jit_tf</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">job_windows</span><span class="p">,</span> <span class="n">shcoords_multiple_scales</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">features_indexes</span><span class="p">)</span>
            <span class="n">job_responses</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">_decision_function_numba_jit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>         
            <span class="k">return</span> <span class="n">job_responses</span> 
        <span class="n">workers_results</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">((</span><span class="n">delayed</span><span class="p">(</span><span class="n">worker</span><span class="p">)(</span><span class="n">job_index</span><span class="p">)</span> <span class="k">for</span> <span class="n">job_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_calls</span><span class="p">)))</span>
        <span class="n">responses</span> <span class="o">=</span>  <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="p">[</span><span class="n">jr</span> <span class="k">for</span> <span class="n">jr</span> <span class="ow">in</span> <span class="n">workers_results</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">decision_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">decision_threshold</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">decision_threshold_</span>
        <span class="n">detected</span> <span class="o">=</span> <span class="n">responses</span> <span class="o">&gt;</span> <span class="n">decision_threshold</span>
        <span class="n">detections</span> <span class="o">=</span> <span class="n">windows</span><span class="p">[</span><span class="n">detected</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="c1"># skipping scale index</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="n">detected</span><span class="p">]</span> 
    <span class="n">t2_parallel</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_parallel</span> <span class="o">=</span> <span class="n">t2_parallel</span> <span class="o">-</span> <span class="n">t1_parallel</span>
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;parallel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_parallel</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_cpu_parallel: all parallel jobs done (haar_features_multiple_windows_numba_jit_tf, clf.decision_function, finding detections (thresholding and indexing); time </span><span class="si">{</span><span class="n">dt_parallel</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>    
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_cpu_parallel done; time: </span><span class="si">{</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>                    
    <span class="k">return</span> <span class="n">detections</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">times</span></div>


<div class="viewcode-block" id="detect_gpu_cuda"><a class="viewcode-back" href="../main_detector.html#main_detector.detect_gpu_cuda">[docs]</a><span class="k">def</span> <span class="nf">detect_gpu_cuda</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">clf</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">features_indexes</span><span class="p">,</span> <span class="n">decision_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">windows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shcoords_multiple_scales</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                    <span class="n">dev_windows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dev_shcoords_multiple_scales</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dev_X_selected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dev_mins_selected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dev_maxes_selected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dev_logits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dev_responses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs detection on an image frame in the `gpu_cude` mode (i.e. using GPU CUDA-based computations for both feature extraction and classifier responses).</span>
<span class="sd">    Called for each frame from within the ``demo_detect_in_video`` function.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[detect_gpu_cuda...]&quot;</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">t1_preprocess</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">i_resized</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">resize_image</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">i_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">i_resized</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">i_h</span><span class="p">,</span> <span class="n">i_w</span> <span class="o">=</span> <span class="n">i_gray</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">t2_preprocess</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_preprocess</span> <span class="o">=</span> <span class="n">t2_preprocess</span> <span class="o">-</span> <span class="n">t1_preprocess</span>
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;preprocess&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_preprocess</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_gpu_cuda: preprocessing done; time: </span><span class="si">{</span><span class="n">dt_preprocess</span><span class="si">}</span><span class="s2"> s; i_gray.shape: </span><span class="si">{</span><span class="n">i_gray</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="n">t1_ii</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">integral_image_numba_jit</span><span class="p">(</span><span class="n">i_gray</span><span class="p">)</span>
    <span class="n">t2_ii</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_ii</span> <span class="o">=</span> <span class="n">t2_ii</span> <span class="o">-</span> <span class="n">t1_ii</span>
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;ii&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_ii</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_gpu_cuda: integral_image_numba_jit done; time: </span><span class="si">{</span><span class="n">dt_ii</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">windows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t1_prepare</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">windows</span><span class="p">,</span> <span class="n">shcoords_multiple_scales</span> <span class="o">=</span> <span class="n">prepare_detection_windows_and_scaled_haar_coords</span><span class="p">(</span><span class="n">i_h</span><span class="p">,</span> <span class="n">i_w</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">features_indexes</span><span class="p">)</span>
        <span class="n">dev_windows</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span>
        <span class="n">dev_shcoords_multiple_scales</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">shcoords_multiple_scales</span><span class="p">)</span>        
        <span class="n">t2_prepare</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">dt_prepare</span> <span class="o">=</span> <span class="n">t2_prepare</span> <span class="o">-</span> <span class="n">t1_prepare</span> 
        <span class="n">times</span><span class="p">[</span><span class="s2">&quot;prepare&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_prepare</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_gpu_cuda: prepare_detection_windows_and_scaled_haar_coords done; time: </span><span class="si">{</span><span class="n">dt_prepare</span><span class="si">}</span><span class="s2"> s; windows to check: </span><span class="si">{</span><span class="n">windows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dev_X_selected</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dev_X_selected</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">device_array</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dev_mins_selected</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dev_mins_selected</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">mins_selected_</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dev_maxes_selected</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>        
        <span class="n">dev_maxes_selected</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">maxes_selected_</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dev_logits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dev_logits</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">logits_</span><span class="p">)</span>                
    <span class="k">if</span> <span class="n">dev_responses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dev_responses</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">device_array</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">t1_haar</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">tpb</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">get_current_device</span><span class="p">()</span><span class="o">.</span><span class="n">MAX_THREADS_PER_BLOCK</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">bpg</span> <span class="o">=</span> <span class="n">windows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dev_ii</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
    <span class="n">haar</span><span class="o">.</span><span class="n">haar_features_multiple_windows_numba_cuda</span><span class="p">[</span><span class="n">bpg</span><span class="p">,</span> <span class="n">tpb</span><span class="p">](</span><span class="n">dev_ii</span><span class="p">,</span> <span class="n">dev_windows</span><span class="p">,</span> <span class="n">dev_shcoords_multiple_scales</span><span class="p">,</span> <span class="n">dev_X_selected</span><span class="p">)</span>
    <span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
    <span class="n">t2_haar</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_haar</span> <span class="o">=</span> <span class="n">t2_haar</span> <span class="o">-</span> <span class="n">t1_haar</span>
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;haar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_haar</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_gpu_cuda: haar_features_multiple_windows_numba_cuda done; time: </span><span class="si">{</span><span class="n">dt_haar</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="n">t1_frbb</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>    
    <span class="n">FastRealBoostBins</span><span class="o">.</span><span class="n">_decision_function_numba_cuda_job_int16</span><span class="p">[</span><span class="n">bpg</span><span class="p">,</span> <span class="n">tpb</span><span class="p">](</span><span class="n">dev_X_selected</span><span class="p">,</span> <span class="n">dev_mins_selected</span><span class="p">,</span> <span class="n">dev_maxes_selected</span><span class="p">,</span> <span class="n">dev_logits</span><span class="p">,</span> <span class="n">dev_responses</span><span class="p">)</span>
    <span class="n">responses</span> <span class="o">=</span> <span class="n">dev_responses</span><span class="o">.</span><span class="n">copy_to_host</span><span class="p">()</span>
    <span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
    <span class="n">t2_frbb</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_frbb</span> <span class="o">=</span> <span class="n">t2_frbb</span> <span class="o">-</span> <span class="n">t1_frbb</span>
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;frbb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_frbb</span>  
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_gpu_cuda: FastRealBoostBins._decision_function_numba_cuda_job_int16 done; time: </span><span class="si">{</span><span class="n">dt_frbb</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="n">t1_ti</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">decision_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">decision_threshold</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">decision_threshold_</span>       
    <span class="n">detected</span> <span class="o">=</span> <span class="n">responses</span> <span class="o">&gt;</span> <span class="n">decision_threshold</span>
    <span class="n">detections</span> <span class="o">=</span> <span class="n">windows</span><span class="p">[</span><span class="n">detected</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="c1"># skipping scale index</span>
    <span class="n">responses</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="n">detected</span><span class="p">]</span> 
    <span class="n">t2_ti</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_ti</span> <span class="o">=</span> <span class="n">t2_ti</span> <span class="o">-</span> <span class="n">t1_ti</span>
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;ti&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_ti</span> 
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_gpu_cuda: finding detections (thresholding and indexing) done; time: </span><span class="si">{</span><span class="n">dt_ti</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>        
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_cuda done; time: </span><span class="si">{</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>                 
    <span class="k">return</span> <span class="n">detections</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">times</span></div>

<div class="viewcode-block" id="detect_gpu_cuda_within_multiple_clfs"><a class="viewcode-back" href="../main_detector.html#main_detector.detect_gpu_cuda_within_multiple_clfs">[docs]</a><span class="k">def</span> <span class="nf">detect_gpu_cuda_within_multiple_clfs</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">clf</span><span class="p">,</span> <span class="n">decision_threshold</span><span class="p">,</span> <span class="n">windows</span><span class="p">,</span> 
                                         <span class="n">dev_windows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dev_shcoords_multiple_scales</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dev_X_selected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dev_mins_selected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dev_maxes_selected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dev_logits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dev_responses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                         <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function called from a detection procedure meant for multiple classifiers - performs detection on an image frame (given its integral image computed earlier) in the `gpu_cude` mode (i.e. using GPU CUDA-based computations for both feature extraction and classifier responses).</span>
<span class="sd">    Called for each frame from within the ``demo_detect_in_video_multiple_clfs`` function.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[detect_gpu_cuda_within_multiple_clfs...]&quot;</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">t1_haar</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">tpb</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">get_current_device</span><span class="p">()</span><span class="o">.</span><span class="n">MAX_THREADS_PER_BLOCK</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">bpg</span> <span class="o">=</span> <span class="n">windows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dev_ii</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
    <span class="n">haar</span><span class="o">.</span><span class="n">haar_features_multiple_windows_numba_cuda</span><span class="p">[</span><span class="n">bpg</span><span class="p">,</span> <span class="n">tpb</span><span class="p">](</span><span class="n">dev_ii</span><span class="p">,</span> <span class="n">dev_windows</span><span class="p">,</span> <span class="n">dev_shcoords_multiple_scales</span><span class="p">,</span> <span class="n">dev_X_selected</span><span class="p">)</span>
    <span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
    <span class="n">t2_haar</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_haar</span> <span class="o">=</span> <span class="n">t2_haar</span> <span class="o">-</span> <span class="n">t1_haar</span>
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;haar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_haar</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_gpu_cuda_within_multiple_clfs: haar_features_multiple_windows_numba_cuda done; time: </span><span class="si">{</span><span class="n">dt_haar</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="n">t1_frbb</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>    
    <span class="n">FastRealBoostBins</span><span class="o">.</span><span class="n">_decision_function_numba_cuda_job_int16</span><span class="p">[</span><span class="n">bpg</span><span class="p">,</span> <span class="n">tpb</span><span class="p">](</span><span class="n">dev_X_selected</span><span class="p">,</span> <span class="n">dev_mins_selected</span><span class="p">,</span> <span class="n">dev_maxes_selected</span><span class="p">,</span> <span class="n">dev_logits</span><span class="p">,</span> <span class="n">dev_responses</span><span class="p">)</span>
    <span class="n">responses</span> <span class="o">=</span> <span class="n">dev_responses</span><span class="o">.</span><span class="n">copy_to_host</span><span class="p">()</span>
    <span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
    <span class="n">t2_frbb</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_frbb</span> <span class="o">=</span> <span class="n">t2_frbb</span> <span class="o">-</span> <span class="n">t1_frbb</span>
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;frbb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_frbb</span>  
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_gpu_cuda_within_multiple_clfs: FastRealBoostBins._decision_function_numba_cuda_job_int16 done; time: </span><span class="si">{</span><span class="n">dt_frbb</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
    <span class="n">t1_ti</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">decision_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">decision_threshold</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">decision_threshold_</span>       
    <span class="n">detected</span> <span class="o">=</span> <span class="n">responses</span> <span class="o">&gt;</span> <span class="n">decision_threshold</span>
    <span class="n">detections</span> <span class="o">=</span> <span class="n">windows</span><span class="p">[</span><span class="n">detected</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="c1"># skipping scale index</span>
    <span class="n">responses</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="n">detected</span><span class="p">]</span> 
    <span class="n">t2_ti</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dt_ti</span> <span class="o">=</span> <span class="n">t2_ti</span> <span class="o">-</span> <span class="n">t1_ti</span>
    <span class="n">times</span><span class="p">[</span><span class="s2">&quot;ti&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_ti</span> 
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_gpu_cuda_within_multiple_clfs: finding detections (thresholding and indexing) done; time: </span><span class="si">{</span><span class="n">dt_ti</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>        
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detect_gpu_cuda_within_multiple_clfs done; time: </span><span class="si">{</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>                 
    <span class="k">return</span> <span class="n">detections</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">times</span></div>

<div class="viewcode-block" id="postprocess_nms"><a class="viewcode-back" href="../main_detector.html#main_detector.postprocess_nms">[docs]</a><span class="k">def</span> <span class="nf">postprocess_nms</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Postprocesses the list of detections (bounding boxes) according to the `non-max suppression` approach.&quot;&quot;&quot;</span>    
    <span class="n">d</span> <span class="o">=</span> <span class="n">detections</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">responses</span>
    <span class="n">d_final</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">r_final</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">detections</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">arg_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;stable&quot;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">arg_sort</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">arg_sort</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">detections</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">d_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">r_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">detections</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">indexes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">continue</span>            
            <span class="k">if</span> <span class="n">haar</span><span class="o">.</span><span class="n">iou2</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">iou_threshold</span><span class="p">:</span>
                <span class="n">indexes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">d_final</span><span class="p">,</span> <span class="n">r_final</span></div>

<div class="viewcode-block" id="postprocess_avg"><a class="viewcode-back" href="../main_detector.html#main_detector.postprocess_avg">[docs]</a><span class="k">def</span> <span class="nf">postprocess_avg</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Postprocesses the list of detections (bounding boxes) according to the `averaging` approach.&quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">detections</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">responses</span>
    <span class="n">d_final</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">r_final</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">detections</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">arg_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;stable&quot;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">arg_sort</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">arg_sort</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">detections</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">d_avg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">r_avg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">d_avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">r_avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">detections</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">indexes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">continue</span>            
            <span class="k">if</span> <span class="n">haar</span><span class="o">.</span><span class="n">iou2</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">iou_threshold</span><span class="p">:</span>
                <span class="n">indexes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">d_avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">r_avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">d_avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d_avg</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">r_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r_avg</span><span class="p">)</span>
        <span class="n">d_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_avg</span><span class="p">)</span>
        <span class="n">r_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_avg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d_final</span><span class="p">,</span> <span class="n">r_final</span></div>

<div class="viewcode-block" id="short_cpu_name"><a class="viewcode-back" href="../main_detector.html#main_detector.short_cpu_name">[docs]</a><span class="k">def</span> <span class="nf">short_cpu_name</span><span class="p">(</span><span class="n">cpu_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a short version of a full CPU name (for the purpose of displaying it on video frames).&quot;&quot;&quot;</span>
    <span class="n">cpu_name</span> <span class="o">=</span> <span class="n">cpu_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;CPU&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">cpu_name</span> <span class="o">=</span> <span class="n">cpu_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">cpu_name</span> <span class="o">=</span> <span class="n">cpu_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">cpu_name</span> <span class="o">=</span> <span class="n">cpu_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; @ &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">cpu_name</span> <span class="o">=</span> <span class="n">cpu_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(R)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cpu_name</span>    </div>

<div class="viewcode-block" id="color_by_detector_title"><a class="viewcode-back" href="../main_detector.html#main_detector.color_by_detector_title">[docs]</a><span class="k">def</span> <span class="nf">color_by_detector_title</span><span class="p">(</span><span class="n">colors_detect</span><span class="p">,</span> <span class="n">detector_title</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a color (meant to draw a detected bounding box) based on a detector title.&quot;&quot;&quot;</span>
    <span class="n">mappings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;face&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;hand&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">detector_title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">mappings</span><span class="p">[</span><span class="n">title</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">colors_detect</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  </div>

<div class="viewcode-block" id="demo_detect_in_video"><a class="viewcode-back" href="../main_detector.html#main_detector.demo_detect_in_video">[docs]</a><span class="k">def</span> <span class="nf">demo_detect_in_video</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">decision_threshold</span><span class="p">,</span> <span class="n">computations</span><span class="o">=</span><span class="s2">&quot;gpu_cuda&quot;</span><span class="p">,</span> <span class="n">postprocess</span><span class="o">=</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">detector_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose_loop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_detect</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs a demonstration of detection procedure (using a single binary classifier - an instance of ``FastRealBoostBins``) in a video sequence captured from camera.</span>
<span class="sd">    Depending on the mode of computations (argument ``computations`` being one of: ``&quot;cpu_simple&quot;``, ``&quot;cpu_parallel&quot;``, ``&quot;gpu_cuda&quot;``),</span>
<span class="sd">    makes calls for each frame to, respectively, one of the following functions: ``detect_cpu_simple``, ``detect_cpu_parallel``, ``detect_gpu_cuda``. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEMO OF DETECT IN VIDEO... [computations: </span><span class="si">{</span><span class="n">computations</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="n">colors_detect</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="n">color_detect</span> <span class="o">=</span> <span class="n">color_by_detector_title</span><span class="p">(</span><span class="n">colors_detect</span><span class="p">,</span> <span class="n">detector_title</span><span class="p">)</span>
    <span class="n">color_info</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">font_size</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">text_shift</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">font_size</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">gpu_name</span> <span class="o">=</span> <span class="n">gpu_props</span><span class="p">()[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="n">cpu_name</span> <span class="o">=</span> <span class="n">short_cpu_name</span><span class="p">(</span><span class="n">cpu_and_system_props</span><span class="p">()[</span><span class="s2">&quot;cpu_name&quot;</span><span class="p">])</span>
    <span class="n">features_indexes</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">features_selected_</span>
    <span class="n">camera_index</span> <span class="o">=</span> <span class="n">CV2_VIDEO_CAPTURE_CAMERA_INDEX</span> <span class="o">+</span> <span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_DSHOW</span> <span class="k">if</span> <span class="n">CV2_VIDEO_CAPTURE_OS_IS_MSWINDOWS</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[about to start video camera with index </span><span class="si">{</span><span class="n">camera_index</span><span class="si">}</span><span class="s2">]...&quot;</span><span class="p">)</span>
    <span class="n">video</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">camera_index</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">,</span> <span class="mi">640</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span> <span class="mi">480</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>    
    <span class="n">_</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">frame_h</span><span class="p">,</span> <span class="n">frame_w</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">resized_height</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">HEIGHT</span>    
    <span class="n">resized_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">resized_height</span><span class="p">))</span>
    <span class="n">windows</span><span class="p">,</span> <span class="n">shcoords_multiple_scales</span> <span class="o">=</span> <span class="n">prepare_detection_windows_and_scaled_haar_coords</span><span class="p">(</span><span class="n">resized_height</span><span class="p">,</span> <span class="n">resized_width</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">features_indexes</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[frame shape: </span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[windows per frame: </span><span class="si">{</span><span class="n">windows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[terms per window: </span><span class="si">{</span><span class="n">clf</span><span class="o">.</span><span class="n">T</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>    
    <span class="n">decision_threshold_source</span> <span class="o">=</span> <span class="s2">&quot;internal (clf.decision_threshold_)&quot;</span> <span class="k">if</span> <span class="n">decision_threshold</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;external (decision_threshold argument)&quot;</span>
    <span class="k">if</span> <span class="n">decision_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">decision_threshold</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">decision_threshold_</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[decision threshold: </span><span class="si">{</span><span class="n">decision_threshold</span><span class="si">}</span><span class="s2">, source: </span><span class="si">{</span><span class="n">decision_threshold_source</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[video camera started]&quot;</span><span class="p">)</span>
    <span class="n">h_scale</span> <span class="o">=</span> <span class="n">frame_h</span> <span class="o">/</span> <span class="n">resized_height</span>
    <span class="n">w_scale</span> <span class="o">=</span> <span class="n">frame_w</span> <span class="o">/</span> <span class="n">resized_width</span>
    <span class="n">n_frames</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ma_decay</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">fps_disp_ma</span> <span class="o">=</span> <span class="mf">0.0</span>    
    <span class="n">fps_disp</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">fps_comps_ma</span> <span class="o">=</span> <span class="mf">0.0</span>    
    <span class="n">fps_comps</span> <span class="o">=</span> <span class="mf">0.0</span>   
    <span class="n">draw_thickness</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">postprocess</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">2</span>
    <span class="c1"># device side arrays in case of cuda method</span>
    <span class="n">dev_windows</span> <span class="o">=</span> <span class="kc">None</span> 
    <span class="n">dev_shcoords_multiple_scales</span> <span class="o">=</span> <span class="kc">None</span>    
    <span class="n">dev_X_selected</span> <span class="o">=</span> <span class="kc">None</span>     
    <span class="n">dev_mins_selected</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dev_maxes_selected</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dev_logits</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dev_responses</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">computations</span> <span class="o">==</span> <span class="s2">&quot;gpu_cuda&quot;</span><span class="p">:</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">windows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">features_indexes</span><span class="o">.</span><span class="n">size</span>
        <span class="n">dev_windows</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span>
        <span class="n">dev_shcoords_multiple_scales</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">shcoords_multiple_scales</span><span class="p">)</span>        
        <span class="n">dev_X_selected</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">device_array</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">dev_mins_selected</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">mins_selected_</span><span class="p">)</span>
        <span class="n">dev_maxes_selected</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">maxes_selected_</span><span class="p">)</span>
        <span class="n">dev_logits</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">logits_</span><span class="p">)</span>
        <span class="n">dev_responses</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">device_array</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">tpf_prev</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">time_comps</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">time_comps_haar</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">time_comps_frbb</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">t1_loop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">while</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose_loop</span><span class="p">:</span>            
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">160</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[frame: </span><span class="si">{</span><span class="n">n_frames</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>        
        <span class="n">t1_read</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">t2_read</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">t1_flip</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">CV2_VIDEO_CAPTURE_NO_FLIP</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">t2_flip</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose_loop</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[read time: </span><span class="si">{</span><span class="n">t2_read</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1_read</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[flip time: </span><span class="si">{</span><span class="n">t2_flip</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1_flip</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[windows per frame: </span><span class="si">{</span><span class="n">windows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[terms per window: </span><span class="si">{</span><span class="n">clf</span><span class="o">.</span><span class="n">T</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>                            
        <span class="n">t1_comps</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">computations</span> <span class="o">==</span> <span class="s2">&quot;cpu_simple&quot;</span><span class="p">:</span>
            <span class="n">detections</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="n">detect_cpu_simple</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">clf</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">features_indexes</span><span class="p">,</span> <span class="n">decision_threshold</span><span class="p">,</span> <span class="n">windows</span><span class="p">,</span> <span class="n">shcoords_multiple_scales</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_detect</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">computations</span> <span class="o">==</span> <span class="s2">&quot;cpu_parallel&quot;</span><span class="p">:</span>
            <span class="n">detections</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="n">detect_cpu_parallel</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">clf</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">features_indexes</span><span class="p">,</span> <span class="n">decision_threshold</span><span class="p">,</span> <span class="n">windows</span><span class="p">,</span> <span class="n">shcoords_multiple_scales</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_detect</span><span class="p">)</span>        
        <span class="k">elif</span> <span class="n">computations</span> <span class="o">==</span> <span class="s2">&quot;gpu_cuda&quot;</span><span class="p">:</span>
            <span class="n">detections</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="n">detect_gpu_cuda</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">clf</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">features_indexes</span><span class="p">,</span> <span class="n">decision_threshold</span><span class="p">,</span> <span class="n">windows</span><span class="p">,</span> <span class="n">shcoords_multiple_scales</span><span class="p">,</span> 
                                                           <span class="n">dev_windows</span><span class="p">,</span> <span class="n">dev_shcoords_multiple_scales</span><span class="p">,</span> <span class="n">dev_X_selected</span><span class="p">,</span> <span class="n">dev_mins_selected</span><span class="p">,</span> <span class="n">dev_maxes_selected</span><span class="p">,</span> <span class="n">dev_logits</span><span class="p">,</span> <span class="n">dev_responses</span><span class="p">,</span> 
                                                           <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_detect</span><span class="p">)</span>                        
        <span class="n">t2_comps</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">t1_post</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">postprocess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">postprocess</span> <span class="o">==</span> <span class="s2">&quot;nms&quot;</span><span class="p">:</span>
                <span class="n">detections</span><span class="p">,</span> <span class="n">responses</span> <span class="o">=</span> <span class="n">postprocess_nms</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">responses</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">postprocess</span> <span class="o">==</span> <span class="s2">&quot;avg&quot;</span><span class="p">:</span>
                <span class="n">detections</span><span class="p">,</span> <span class="n">responses</span> <span class="o">=</span> <span class="n">postprocess_avg</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">responses</span><span class="p">)</span>
        <span class="n">t2_post</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">t1_other</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">j0</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">detections</span><span class="p">):</span>
            <span class="n">js</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j0</span> <span class="o">*</span> <span class="n">h_scale</span><span class="p">))</span>
            <span class="n">ks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">k0</span> <span class="o">*</span> <span class="n">w_scale</span><span class="p">))</span>
            <span class="n">hs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">h_scale</span><span class="p">))</span>
            <span class="n">ws</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">w_scale</span><span class="p">))</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">js</span><span class="p">),</span> <span class="p">(</span><span class="n">ks</span> <span class="o">+</span> <span class="n">ws</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">js</span> <span class="o">+</span> <span class="n">hs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">color_detect</span><span class="p">,</span> <span class="n">draw_thickness</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">postprocess</span><span class="p">:</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">responses</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">js</span> <span class="o">+</span> <span class="n">ws</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_detect</span><span class="p">,</span> <span class="n">draw_thickness</span><span class="p">)</span>
        <span class="n">normalizer_ma</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ma_decay</span><span class="o">**</span><span class="p">(</span><span class="n">n_frames</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">n_frames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fps_disp_ma</span> <span class="o">=</span> <span class="n">ma_decay</span> <span class="o">*</span> <span class="n">fps_disp_ma</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ma_decay</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">tpf_prev</span>
            <span class="n">fps_disp</span> <span class="o">=</span> <span class="n">fps_disp_ma</span> <span class="o">*</span> <span class="n">normalizer_ma</span>
        <span class="n">fps_comps_ma</span> <span class="o">=</span> <span class="n">ma_decay</span> <span class="o">*</span> <span class="n">fps_comps_ma</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ma_decay</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">t2_comps</span> <span class="o">-</span> <span class="n">t1_comps</span><span class="p">)</span>
        <span class="n">fps_comps</span> <span class="o">=</span> <span class="n">fps_comps_ma</span> <span class="o">*</span> <span class="n">normalizer_ma</span>            
        <span class="n">time_comps</span> <span class="o">+=</span> <span class="n">t2_comps</span> <span class="o">-</span> <span class="n">t1_comps</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s2">&quot;DEMO: FAST REAL BOOST BINS VIA NUMBA (+HAAR FEATURES)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">text_shift</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;DETECTOR KIND: </span><span class="si">{</span><span class="n">detector_title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">text_shift</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;FRAME: </span><span class="si">{</span><span class="n">n_frames</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">text_shift</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;WINDOWS PER FRAME: </span><span class="si">{</span><span class="n">windows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame_h</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">text_shift</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;TERMS PER WINDOW: </span><span class="si">{</span><span class="n">clf</span><span class="o">.</span><span class="n">T</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame_h</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">text_shift</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">computations_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;COMPUTATIONS: </span><span class="si">{</span><span class="n">computations</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">computations</span> <span class="o">==</span> <span class="s2">&quot;gpu_cuda&quot;</span><span class="p">:</span>
            <span class="n">computations_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; [GPU: </span><span class="si">{</span><span class="n">gpu_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">computations_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; [CPU: </span><span class="si">{</span><span class="n">cpu_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">]&quot;</span>            
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">computations_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame_h</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">text_shift</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">comps_details</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;haar&quot;</span> <span class="ow">in</span> <span class="n">times</span> <span class="ow">and</span> <span class="s2">&quot;frbb&quot;</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
            <span class="n">comps_details</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;[HAAR: </span><span class="si">{</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;haar&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="si">:</span><span class="s2">06.2f</span><span class="si">}</span><span class="s2"> ms&quot;</span>            
            <span class="n">comps_details</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, FRBB: </span><span class="si">{</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;frbb&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="si">:</span><span class="s2">06.2f</span><span class="si">}</span><span class="s2"> ms]&quot;</span>
            <span class="n">time_comps_haar</span> <span class="o">+=</span> <span class="n">times</span><span class="p">[</span><span class="s2">&quot;haar&quot;</span><span class="p">]</span>
            <span class="n">time_comps_frbb</span> <span class="o">+=</span> <span class="n">times</span><span class="p">[</span><span class="s2">&quot;frbb&quot;</span><span class="p">]</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;FPS (COMPUTATIONS): </span><span class="si">{</span><span class="n">fps_comps</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">comps_details</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame_h</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">text_shift</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;FPS (DISPLAY): </span><span class="si">{</span><span class="n">fps_disp</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame_h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>                    
        <span class="n">imshow_name</span> <span class="o">=</span> <span class="s2">&quot;FAST REAL BOOST BINS [&#39;esc&#39; to quit]&quot;</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="n">imshow_name</span><span class="p">)</span>             
        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imshow_name</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">n_frames</span> <span class="o">+=</span> <span class="mi">1</span>        
        <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="mi">27</span> <span class="ow">or</span> <span class="p">(</span><span class="n">DEMO_DETECT_IN_VIDEO_FRAMES</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_frames</span> <span class="o">&gt;=</span> <span class="n">DEMO_DETECT_IN_VIDEO_FRAMES</span><span class="p">):</span> <span class="c1"># esc key</span>
            <span class="k">break</span>       
        <span class="n">t2_other</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>                
        <span class="k">if</span> <span class="n">verbose_loop</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[computations time: </span><span class="si">{</span><span class="n">t2_comps</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1_comps</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[postprocess time: </span><span class="si">{</span><span class="n">t2_post</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1_post</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[other time: </span><span class="si">{</span><span class="n">t2_other</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1_other</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[fps (computations): </span><span class="si">{</span><span class="n">fps_comps</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[fps (display): </span><span class="si">{</span><span class="n">fps_disp</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detections in this frame: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">detections</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>           
        <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tpf_prev</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span>        
    <span class="n">t2_loop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
    <span class="n">video</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>    
    <span class="n">avg_fps_comps</span> <span class="o">=</span> <span class="n">n_frames</span> <span class="o">/</span> <span class="n">time_comps</span>
    <span class="n">avg_time_comps_haar</span> <span class="o">=</span> <span class="n">time_comps_haar</span> <span class="o">/</span> <span class="n">n_frames</span>
    <span class="n">avg_time_comps_frbb</span> <span class="o">=</span> <span class="n">time_comps_frbb</span> <span class="o">/</span> <span class="n">n_frames</span>
    <span class="n">avg_fps_disp</span> <span class="o">=</span> <span class="n">n_frames</span> <span class="o">/</span> <span class="p">(</span><span class="n">t2_loop</span> <span class="o">-</span> <span class="n">t1_loop</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEMO OF DETECT IN VIDEO DONE. [avg fps (computations): </span><span class="si">{</span><span class="n">avg_fps_comps</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, avg time haar: </span><span class="si">{</span><span class="n">avg_time_comps_haar</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ms, avg time frbb: </span><span class="si">{</span><span class="n">avg_time_comps_frbb</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ms; avg fps (display): </span><span class="si">{</span><span class="n">avg_fps_disp</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="demo_detect_in_video_multiple_clfs"><a class="viewcode-back" href="../main_detector.html#main_detector.demo_detect_in_video_multiple_clfs">[docs]</a><span class="k">def</span> <span class="nf">demo_detect_in_video_multiple_clfs</span><span class="p">(</span><span class="n">clfs</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">decision_thresholds</span><span class="p">,</span> <span class="n">postprocess</span><span class="o">=</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span> <span class="n">detector_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose_loop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_detect</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs a demonstration of detection procedure (using multiple binary classifiers - instances of ``FastRealBoostBins``) in a video sequence captured from camera.    </span>
<span class="sd">    For each frame makes of call to ``detect_gpu_cuda_within_multiple_clfs`` function.     </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEMO OF DETECT IN VIDEO  (MULTIPLE CLFS)...&quot;</span><span class="p">)</span>
    <span class="n">colors_detect</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="n">color_info</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">font_size</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">text_shift</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">font_size</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>        
    <span class="n">gpu_name</span> <span class="o">=</span> <span class="n">gpu_props</span><span class="p">()[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="n">camera_index</span> <span class="o">=</span> <span class="n">CV2_VIDEO_CAPTURE_CAMERA_INDEX</span> <span class="o">+</span> <span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_DSHOW</span> <span class="k">if</span> <span class="n">CV2_VIDEO_CAPTURE_OS_IS_MSWINDOWS</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[about to start video camera with index </span><span class="si">{</span><span class="n">camera_index</span><span class="si">}</span><span class="s2">...]&quot;</span><span class="p">)</span>
    <span class="n">video</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">camera_index</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">,</span> <span class="mi">640</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span> <span class="mi">480</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>    
    <span class="n">_</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">frame_h</span><span class="p">,</span> <span class="n">frame_w</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">resized_height</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">HEIGHT</span>    
    <span class="n">resized_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">resized_height</span><span class="p">))</span>    
    <span class="n">windows</span> <span class="o">=</span> <span class="n">prepare_detection_windows</span><span class="p">(</span><span class="n">resized_height</span><span class="p">,</span> <span class="n">resized_width</span><span class="p">)</span>    
    <span class="n">shcoords_multiple_scales</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">features_indexes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">clf</span> <span class="ow">in</span> <span class="n">clfs</span><span class="p">:</span>
        <span class="n">features_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">features_selected_</span><span class="p">)</span>
        <span class="n">shcoords_multiple_scales</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepare_scaled_haar_coords</span><span class="p">(</span><span class="n">hcoords</span><span class="p">,</span> <span class="n">clf</span><span class="o">.</span><span class="n">features_selected_</span><span class="p">))</span>            
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[frame shape: </span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[windows per frame: </span><span class="si">{</span><span class="n">windows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[terms per window per clfs: </span><span class="si">{</span><span class="p">[</span><span class="n">clf</span><span class="o">.</span><span class="n">T</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">clf</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">clfs</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>        
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[decision thresholds within clfs (internal): </span><span class="si">{</span><span class="p">[</span><span class="n">clf</span><span class="o">.</span><span class="n">decision_threshold_</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">clf</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">clfs</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[decision thresholds (external overriding argument): </span><span class="si">{</span><span class="n">decision_thresholds</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>        
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[video camera started]&quot;</span><span class="p">)</span>
    <span class="n">h_scale</span> <span class="o">=</span> <span class="n">frame_h</span> <span class="o">/</span> <span class="n">resized_height</span>
    <span class="n">w_scale</span> <span class="o">=</span> <span class="n">frame_w</span> <span class="o">/</span> <span class="n">resized_width</span> 
    <span class="n">n_frames</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ma_decay</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">fps_disp_ma</span> <span class="o">=</span> <span class="mf">0.0</span>    
    <span class="n">fps_disp</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">fps_comps_ma</span> <span class="o">=</span> <span class="mf">0.0</span>    
    <span class="n">fps_comps</span> <span class="o">=</span> <span class="mf">0.0</span>   
    <span class="n">draw_thickness</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">postprocess</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">2</span>
    <span class="c1"># device side arrays in case of cuda method </span>
    <span class="n">dev_shcoords_multiple_scales</span> <span class="o">=</span> <span class="p">[]</span>    
    <span class="n">dev_X_selected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dev_mins_selected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dev_maxes_selected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dev_logits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dev_responses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dev_windows</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">clf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clfs</span><span class="p">):</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">windows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">features_indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>        
        <span class="n">dev_shcoords_multiple_scales</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">shcoords_multiple_scales</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>        
        <span class="n">dev_X_selected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_array</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">))</span>
        <span class="n">dev_mins_selected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">mins_selected_</span><span class="p">))</span>
        <span class="n">dev_maxes_selected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">maxes_selected_</span><span class="p">))</span>
        <span class="n">dev_logits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cuda</span><span class="o">.</span><span class="n">to_device</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">logits_</span><span class="p">))</span>
        <span class="n">dev_responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_array</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">tpf_prev</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">time_comps</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">time_comps_haar</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">time_comps_frbb</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">t1_loop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">while</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose_loop</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">160</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[frame: </span><span class="si">{</span><span class="n">n_frames</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>        
        <span class="n">t1_read</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">t2_read</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">t1_flip</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">CV2_VIDEO_CAPTURE_NO_FLIP</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">t2_flip</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>        
        <span class="n">tpf_comps</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">tpf_post</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">times_haar</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">times_frbb</span> <span class="o">=</span> <span class="mf">0.0</span>        
        <span class="n">t1_preprocess</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">i_resized</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">resize_image</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">i_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">i_resized</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">t2_preprocess</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>            
        <span class="n">t1_ii</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">integral_image_numba_jit</span><span class="p">(</span><span class="n">i_gray</span><span class="p">)</span>
        <span class="n">t2_ii</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>                    
        <span class="k">if</span> <span class="n">verbose_loop</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[read time: </span><span class="si">{</span><span class="n">t2_read</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1_read</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[flip time: </span><span class="si">{</span><span class="n">t2_flip</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1_flip</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[preprocessing done; time: </span><span class="si">{</span><span class="n">t2_preprocess</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1_preprocess</span><span class="si">}</span><span class="s2"> s; i_gray.shape: </span><span class="si">{</span><span class="n">i_gray</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[integral image done; time: </span><span class="si">{</span><span class="n">t2_ii</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1_ii</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[windows per frame: </span><span class="si">{</span><span class="n">windows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[terms per window per clfs: </span><span class="si">{</span><span class="p">[</span><span class="n">clf</span><span class="o">.</span><span class="n">T</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">clf</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">clfs</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clfs</span><span class="p">)):</span>
            <span class="n">t1_comps</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>      
            <span class="n">detections</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="n">detect_gpu_cuda_within_multiple_clfs</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">clfs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">decision_thresholds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">windows</span><span class="p">,</span> 
                                                                                <span class="n">dev_windows</span><span class="p">,</span> <span class="n">dev_shcoords_multiple_scales</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dev_X_selected</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dev_mins_selected</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dev_maxes_selected</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dev_logits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dev_responses</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                                                                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_detect</span><span class="p">)</span>
            <span class="n">t2_comps</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">tpf_comps</span> <span class="o">+=</span> <span class="n">t2_comps</span> <span class="o">-</span> <span class="n">t1_comps</span>            
            <span class="n">t1_post</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">postprocess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">postprocess</span> <span class="o">==</span> <span class="s2">&quot;nms&quot;</span><span class="p">:</span>
                    <span class="n">detections</span><span class="p">,</span> <span class="n">responses</span> <span class="o">=</span> <span class="n">postprocess_nms</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">responses</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">postprocess</span> <span class="o">==</span> <span class="s2">&quot;avg&quot;</span><span class="p">:</span>
                    <span class="n">detections</span><span class="p">,</span> <span class="n">responses</span> <span class="o">=</span> <span class="n">postprocess_avg</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">responses</span><span class="p">)</span>
            <span class="n">t2_post</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">tpf_post</span> <span class="o">+=</span> <span class="n">t2_post</span> <span class="o">-</span> <span class="n">t1_post</span>
            <span class="k">if</span> <span class="n">times</span><span class="p">[</span><span class="s2">&quot;haar&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">times</span><span class="p">[</span><span class="s2">&quot;frbb&quot;</span><span class="p">]:</span>
                <span class="n">times_haar</span> <span class="o">+=</span> <span class="n">times</span><span class="p">[</span><span class="s2">&quot;haar&quot;</span><span class="p">]</span>
                <span class="n">times_frbb</span> <span class="o">+=</span> <span class="n">times</span><span class="p">[</span><span class="s2">&quot;frbb&quot;</span><span class="p">]</span> 
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">j0</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">detections</span><span class="p">):</span>
                <span class="n">js</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j0</span> <span class="o">*</span> <span class="n">h_scale</span><span class="p">))</span>
                <span class="n">ks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">k0</span> <span class="o">*</span> <span class="n">w_scale</span><span class="p">))</span>
                <span class="n">hs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">h_scale</span><span class="p">))</span>
                <span class="n">ws</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">w_scale</span><span class="p">))</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">js</span><span class="p">),</span> <span class="p">(</span><span class="n">ks</span> <span class="o">+</span> <span class="n">ws</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">js</span> <span class="o">+</span> <span class="n">hs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">colors_detect</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">draw_thickness</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">postprocess</span><span class="p">:</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">responses</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">js</span> <span class="o">+</span> <span class="n">ws</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">colors_detect</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">draw_thickness</span><span class="p">)</span>            
        <span class="n">normalizer_ma</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ma_decay</span><span class="o">**</span><span class="p">(</span><span class="n">n_frames</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">n_frames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fps_disp_ma</span> <span class="o">=</span> <span class="n">ma_decay</span> <span class="o">*</span> <span class="n">fps_disp_ma</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ma_decay</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">tpf_prev</span>
            <span class="n">fps_disp</span> <span class="o">=</span> <span class="n">fps_disp_ma</span> <span class="o">*</span> <span class="n">normalizer_ma</span>
        <span class="n">fps_comps_ma</span> <span class="o">=</span> <span class="n">ma_decay</span> <span class="o">*</span> <span class="n">fps_comps_ma</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ma_decay</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">tpf_comps</span>
        <span class="n">fps_comps</span> <span class="o">=</span> <span class="n">fps_comps_ma</span> <span class="o">*</span> <span class="n">normalizer_ma</span>
        <span class="n">time_comps</span> <span class="o">+=</span> <span class="n">tpf_comps</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s2">&quot;DEMO: FAST REAL BOOST BINS VIA NUMBA (+HAAR FEATURES)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">text_shift</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;DETECTOR KIND: </span><span class="si">{</span><span class="n">detector_title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">text_shift</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;FRAME: </span><span class="si">{</span><span class="n">n_frames</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">text_shift</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>        
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;WINDOWS PER FRAME: </span><span class="si">{</span><span class="n">windows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame_h</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">text_shift</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;TERMS PER WINDOW PER CLFS: </span><span class="si">{</span><span class="p">[</span><span class="n">clf</span><span class="o">.</span><span class="n">T</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">clf</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">clfs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame_h</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">text_shift</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">computations_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;COMPUTATIONS: CUDA&quot;</span>
        <span class="n">computations_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; [GPU: </span><span class="si">{</span><span class="n">gpu_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">computations_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame_h</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">text_shift</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">comps_details</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">times_haar</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">times_frbb</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">comps_details</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;[HAAR: </span><span class="si">{</span><span class="n">times_haar</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="si">:</span><span class="s2">06.2f</span><span class="si">}</span><span class="s2"> ms&quot;</span>            
            <span class="n">comps_details</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, FRBB: </span><span class="si">{</span><span class="n">times_frbb</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="si">:</span><span class="s2">06.2f</span><span class="si">}</span><span class="s2"> ms]&quot;</span>
            <span class="n">time_comps_haar</span> <span class="o">+=</span> <span class="n">times_haar</span>
            <span class="n">time_comps_frbb</span> <span class="o">+=</span> <span class="n">times_frbb</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;FPS (COMPUTATIONS): </span><span class="si">{</span><span class="n">fps_comps</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">comps_details</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame_h</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">text_shift</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;FPS (DISPLAY): </span><span class="si">{</span><span class="n">fps_disp</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame_h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">color_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>                    
        <span class="n">imshow_name</span> <span class="o">=</span> <span class="s2">&quot;FAST REAL BOOST BINS [&#39;esc&#39; to quit]&quot;</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="n">imshow_name</span><span class="p">)</span>                     
        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imshow_name</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">n_frames</span> <span class="o">+=</span> <span class="mi">1</span>        
        <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="mi">27</span> <span class="ow">or</span> <span class="p">(</span><span class="n">DEMO_DETECT_IN_VIDEO_FRAMES</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_frames</span> <span class="o">&gt;=</span> <span class="n">DEMO_DETECT_IN_VIDEO_FRAMES</span><span class="p">):</span> <span class="c1"># esc key</span>
            <span class="k">break</span>        
        <span class="k">if</span> <span class="n">verbose_loop</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[computations time: </span><span class="si">{</span><span class="n">tpf_comps</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[postprocess time: </span><span class="si">{</span><span class="n">tpf_post</span><span class="si">}</span><span class="s2"> s]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[fps (computations): </span><span class="si">{</span><span class="n">fps_comps</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[fps (display): </span><span class="si">{</span><span class="n">fps_disp</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[detections in this frame: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">detections</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>           
        <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tpf_prev</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span>        
    <span class="n">t2_loop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
    <span class="n">video</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>    
    <span class="n">avg_fps_comps</span> <span class="o">=</span> <span class="n">n_frames</span> <span class="o">/</span> <span class="n">time_comps</span>
    <span class="n">avg_time_comps_haar</span> <span class="o">=</span> <span class="n">time_comps_haar</span> <span class="o">/</span> <span class="n">n_frames</span>
    <span class="n">avg_time_comps_frbb</span> <span class="o">=</span> <span class="n">time_comps_frbb</span> <span class="o">/</span> <span class="n">n_frames</span>
    <span class="n">avg_fps_disp</span> <span class="o">=</span> <span class="n">n_frames</span> <span class="o">/</span> <span class="p">(</span><span class="n">t2_loop</span> <span class="o">-</span> <span class="n">t1_loop</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEMO OF DETECT IN VIDEO (MULTIPLE CLFS) DONE. [avg fps (computations): </span><span class="si">{</span><span class="n">avg_fps_comps</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, avg time haar: </span><span class="si">{</span><span class="n">avg_time_comps_haar</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ms, avg time frbb: </span><span class="si">{</span><span class="n">avg_time_comps_frbb</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ms; avg fps (display): </span><span class="si">{</span><span class="n">avg_fps_disp</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="str_to_float_or_none"><a class="viewcode-back" href="../main_detector.html#main_detector.str_to_float_or_none">[docs]</a><span class="k">def</span> <span class="nf">str_to_float_or_none</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Utility function for ``argparse.ArgumentParser`` (see ``parse_args`` function) meant to return a floating-point number from its string representation or a ``None`` value.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>

<div class="viewcode-block" id="str_to_int_or_none"><a class="viewcode-back" href="../main_detector.html#main_detector.str_to_int_or_none">[docs]</a><span class="k">def</span> <span class="nf">str_to_int_or_none</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Utility function for ``argparse.ArgumentParser`` (see ``parse_args`` function) meant to return an integer from its string representation or a ``None`` value.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>

<div class="viewcode-block" id="parse_args"><a class="viewcode-back" href="../main_detector.html#main_detector.parse_args">[docs]</a><span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of arguments specified by user from CLI.&quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-k&quot;</span><span class="p">,</span> <span class="s2">&quot;--KIND&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">KIND</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;face&quot;</span><span class="p">,</span> <span class="s2">&quot;hand&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;detector kind (default: </span><span class="si">{</span><span class="n">KIND</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--S&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">S</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">scales</span><span class="se">\&quot;</span><span class="s2"> parameter of Haar-like features (default: </span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="s2">&quot;--P&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">positions</span><span class="se">\&quot;</span><span class="s2"> parameter of Haar-like features (default: </span><span class="si">{</span><span class="n">P</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-npi&quot;</span><span class="p">,</span> <span class="s2">&quot;--NPI&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">NPI</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">negatives per image</span><span class="se">\&quot;</span><span class="s2"> parameter, used in procedures generating data sets from images (default: </span><span class="si">{</span><span class="n">NPI</span><span class="si">}</span><span class="s2"> with -k set to </span><span class="si">{</span><span class="n">KIND</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="s2">&quot;--T&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;number of boosting rounds, (default: </span><span class="si">{</span><span class="n">T</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-b&quot;</span><span class="p">,</span> <span class="s2">&quot;--B&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">B</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;numbet of bins, (default: </span><span class="si">{</span><span class="n">B</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-seed&quot;</span><span class="p">,</span> <span class="s2">&quot;--SEED&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">SEED</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;randomization seed, (default: </span><span class="si">{</span><span class="n">SEED</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-dhfsa&quot;</span><span class="p">,</span> <span class="s2">&quot;--DEMO_HAAR_FEATURES_ALL&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;turn on demo of all Haar-like features&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-dhfss&quot;</span><span class="p">,</span> <span class="s2">&quot;--DEMO_HAAR_FEATURES_SELECTED&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;turn on demo of selected Haar-like features&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-rd&quot;</span><span class="p">,</span> <span class="s2">&quot;--REGENERATE_DATA&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;turn on data regeneration&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-form&quot;</span><span class="p">,</span> <span class="s2">&quot;--FIT_OR_REFIT_MODEL&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;fit new or refit an existing model&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-maom&quot;</span><span class="p">,</span> <span class="s2">&quot;--MEASURE_ACCS_OF_MODEL&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;measure accuracies of a model&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-adtom&quot;</span><span class="p">,</span> <span class="s2">&quot;--ADJUST_DECISION_THRESHOLD_OF_MODEL&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;adjust decision threshold of a model (based on ROC for testing data)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-ddiv&quot;</span><span class="p">,</span> <span class="s2">&quot;--DEMO_DETECT_IN_VIDEO&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;turn on demo of detection in video&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-ddivc&quot;</span><span class="p">,</span> <span class="s2">&quot;--DEMO_DETECT_IN_VIDEO_COMPUTATIONS&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gpu_cuda&quot;</span><span class="p">,</span> <span class="s2">&quot;cpu_simple&quot;</span><span class="p">,</span> <span class="s2">&quot;cpu_parallel&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">DEMO_DETECT_IN_VIDEO_COMPUTATIONS</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;type of computations for demo of detection in video (default: </span><span class="si">{</span><span class="n">DEMO_DETECT_IN_VIDEO_COMPUTATIONS</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-ddivpj&quot;</span><span class="p">,</span> <span class="s2">&quot;--DEMO_DETECT_IN_VIDEO_PARALLEL_JOBS&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEMO_DETECT_IN_VIDEO_PARALLEL_JOBS</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;number of parallel jobs (only in case of cpu_parallel set for -ddivc) (default: </span><span class="si">{</span><span class="n">DEMO_DETECT_IN_VIDEO_PARALLEL_JOBS</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-ddivvl&quot;</span><span class="p">,</span> <span class="s2">&quot;--DEMO_DETECT_IN_VIDEO_VERBOSE_LOOP&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;turn on verbosity for main loop of detection in video&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-ddivvd&quot;</span><span class="p">,</span> <span class="s2">&quot;--DEMO_DETECT_IN_VIDEO_VERBOSE_DETECT&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;turn on detailed verbosity for detection in video&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-ddivf&quot;</span><span class="p">,</span> <span class="s2">&quot;--DEMO_DETECT_IN_VIDEO_FRAMES&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">str_to_float_or_none</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEMO_DETECT_IN_VIDEO_FRAMES</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;limit overall detection in video to given number of frames&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-ddivmc&quot;</span><span class="p">,</span> <span class="s2">&quot;--DEMO_DETECT_IN_VIDEO_MULTIPLE_CLFS&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;turn on demo of detection in video with multiple classifiers (currently: face and hand detectors)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-cv2vcci&quot;</span><span class="p">,</span> <span class="s2">&quot;--CV2_VIDEO_CAPTURE_CAMERA_INDEX&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">CV2_VIDEO_CAPTURE_CAMERA_INDEX</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;video camera index (default: </span><span class="si">{</span><span class="n">CV2_VIDEO_CAPTURE_CAMERA_INDEX</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-cv2oim&quot;</span><span class="p">,</span> <span class="s2">&quot;--CV2_VIDEO_CAPTURE_OS_IS_MSWINDOWS&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;indicates that OS is MS Windows (for cv2 and directx purposes)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-cv2nf&quot;</span><span class="p">,</span> <span class="s2">&quot;--CV2_VIDEO_CAPTURE_NO_FLIP&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;indicates that no frame flipping is wanted&quot;</span><span class="p">)</span>    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-ds&quot;</span><span class="p">,</span> <span class="s2">&quot;--DETECTION_SCALES&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DETECTION_SCALES</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;number of detection scales (default: </span><span class="si">{</span><span class="n">DETECTION_SCALES</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-dwhm&quot;</span><span class="p">,</span> <span class="s2">&quot;--DETECTION_WINDOW_HEIGHT_MIN&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DETECTION_WINDOW_HEIGHT_MIN</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;minimum height of detection window (default: </span><span class="si">{</span><span class="n">DETECTION_WINDOW_HEIGHT_MIN</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-dwwm&quot;</span><span class="p">,</span> <span class="s2">&quot;--DETECTION_WINDOW_WIDTH_MIN&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DETECTION_WINDOW_WIDTH_MIN</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;minimum width of detection window (default: </span><span class="si">{</span><span class="n">DETECTION_WINDOW_WIDTH_MIN</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-dwg&quot;</span><span class="p">,</span> <span class="s2">&quot;--DETECTION_WINDOW_GROWTH&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DETECTION_WINDOW_GROWTH</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;growth factor of detection window (default: </span><span class="si">{</span><span class="n">DETECTION_WINDOW_GROWTH</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-dwj&quot;</span><span class="p">,</span> <span class="s2">&quot;--DETECTION_WINDOW_JUMP&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DETECTION_WINDOW_JUMP</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;relative jump of detection window (default: </span><span class="si">{</span><span class="n">DETECTION_WINDOW_JUMP</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-ddt&quot;</span><span class="p">,</span> <span class="s2">&quot;--DETECTION_DECISION_THRESHOLD&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">str_to_float_or_none</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DETECTION_DECISION_THRESHOLD</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;decision threshold, can be set to None then classifier&#39;s internal threshold is used (default: </span><span class="si">{</span><span class="n">DETECTION_DECISION_THRESHOLD</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-dp&quot;</span><span class="p">,</span> <span class="s2">&quot;--DETECTION_POSTPROCESS&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;avg&quot;</span><span class="p">,</span> <span class="s2">&quot;nms&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">DETECTION_POSTPROCESS</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;type of detection postprocessing (default: </span><span class="si">{</span><span class="n">DETECTION_POSTPROCESS</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-mccn&quot;</span><span class="p">,</span> <span class="s2">&quot;--MC_CLFS_NAMES&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">MC_CLFS_NAMES</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;classifiers names (list) for detection with multiple classifiers (default: </span><span class="si">{</span><span class="n">MC_CLFS_NAMES</span><span class="si">}</span><span class="s2">) (attention: type them using spaces as separators)&quot;</span><span class="p">)</span>    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-mcdt&quot;</span><span class="p">,</span> <span class="s2">&quot;--MC_DECISION_THRESHOLDS&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">str_to_float_or_none</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">MC_DECISION_THRESHOLDS</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;decision thresholds (list) for detection with multiple classifiers, any can be set to None (default: </span><span class="si">{</span><span class="n">MC_DECISION_THRESHOLDS</span><span class="si">}</span><span class="s2">) (attention: type them using spaces as separators)&quot;</span><span class="p">)</span>                                    
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">DETECTION_DECISION_THRESHOLD</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">DETECTION_DECISION_THRESHOLD</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">DETECTION_POSTPROCESS</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">DETECTION_POSTPROCESS</span> <span class="o">=</span> <span class="kc">None</span>    
    <span class="k">return</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>            </div>

<span class="c1"># ----------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># MAIN</span>
<span class="c1"># ----------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>   
    <span class="n">colorama</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>     
    <span class="nb">print</span><span class="p">(</span><span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">LIGHTYELLOW_EX</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">FAST-REAL-BOOST-BINS</span><span class="se">\&quot;</span><span class="s2">: AN ENSEMBLE CLASSIFIER FOR FAST PREDICTIONS IMPLEMENTED IN PYTHON VIA NUMBA.JIT AND NUMBA.CUDA. [main_detector]&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span> <span class="o">+</span> <span class="s2">&quot;[for help use -h or --help switch]&quot;</span> <span class="o">+</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MAIN-DETECTOR STARTING...&quot;</span><span class="p">)</span>  
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CPU AND SYSTEM PROPS: </span><span class="si">{</span><span class="n">cpu_and_system_props</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GPU PROPS: </span><span class="si">{</span><span class="n">gpu_props</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ARGUMENTS:</span><span class="se">\n</span><span class="si">{</span><span class="n">dict_to_str</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>    

    <span class="n">n</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">HAAR_TEMPLATES</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">S</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">P</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>    
    <span class="n">hinds</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">haar_indexes</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
    <span class="n">hcoords</span> <span class="o">=</span> <span class="n">haar</span><span class="o">.</span><span class="n">haar_coords</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">hinds</span><span class="p">)</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">data_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">KIND</span><span class="si">}</span><span class="s2">_n_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">_S_</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">_P_</span><span class="si">{</span><span class="n">P</span><span class="si">}</span><span class="s2">_NPI_</span><span class="si">{</span><span class="n">NPI</span><span class="si">}</span><span class="s2">_SEED_</span><span class="si">{</span><span class="n">SEED</span><span class="si">}</span><span class="s2">&quot;</span> 
    <span class="n">DATA_NAME</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data_</span><span class="si">{</span><span class="n">data_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">CLF_NAME</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;clf_frbb_</span><span class="si">{</span><span class="n">data_suffix</span><span class="si">}</span><span class="s2">_T_</span><span class="si">{</span><span class="n">T</span><span class="si">}</span><span class="s2">_B_</span><span class="si">{</span><span class="n">B</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">if</span> <span class="n">DEMO_HAAR_FEATURES_ALL</span> <span class="ow">or</span> <span class="n">REGENERATE_DATA</span> <span class="ow">or</span> <span class="n">FIT_OR_REFIT_MODEL</span> <span class="ow">or</span> <span class="n">DEMO_HAAR_FEATURES_SELECTED</span> <span class="ow">or</span> <span class="n">MEASURE_ACCS_OF_MODEL</span> <span class="ow">or</span> <span class="n">ADJUST_DECISION_THRESHOLD_OF_MODEL</span> <span class="ow">or</span> <span class="n">DEMO_DETECT_IN_VIDEO</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DATA NAME: </span><span class="si">{</span><span class="n">DATA_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CLF NAME: </span><span class="si">{</span><span class="n">CLF_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">DEMO_HAAR_FEATURES_ALL</span><span class="p">:</span>
        <span class="n">demo_haar_features</span><span class="p">(</span><span class="n">hinds</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>      
    
    <span class="k">if</span> <span class="n">REGENERATE_DATA</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">KIND</span> <span class="o">==</span> <span class="s2">&quot;face&quot;</span><span class="p">:</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">datagenerator</span><span class="o">.</span><span class="n">fddb_data_to_haar</span><span class="p">(</span><span class="n">hcoords</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">NPI</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">KIND</span> <span class="o">==</span> <span class="s2">&quot;hand&quot;</span><span class="p">:</span>                        
            <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">datagenerator</span><span class="o">.</span><span class="n">hagrid_data_to_haar</span><span class="p">(</span><span class="n">hcoords</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">NPI</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">pickle_objects</span><span class="p">(</span><span class="n">FOLDER_DATA</span> <span class="o">+</span> <span class="n">DATA_NAME</span> <span class="o">+</span> <span class="s2">&quot;.bin&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">])</span>    
    
    <span class="k">if</span> <span class="n">FIT_OR_REFIT_MODEL</span> <span class="ow">or</span> <span class="n">MEASURE_ACCS_OF_MODEL</span> <span class="ow">or</span> <span class="n">ADJUST_DECISION_THRESHOLD_OF_MODEL</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">REGENERATE_DATA</span><span class="p">:</span> 
            <span class="p">[</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">]</span> <span class="o">=</span> <span class="n">unpickle_objects</span><span class="p">(</span><span class="n">FOLDER_DATA</span> <span class="o">+</span> <span class="n">DATA_NAME</span> <span class="o">+</span> <span class="s2">&quot;.bin&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[X_train.shape: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> positives, X_test.shape: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> positives]&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">FIT_OR_REFIT_MODEL</span><span class="p">:</span> 
        <span class="n">clf</span> <span class="o">=</span> <span class="n">FastRealBoostBins</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="n">B</span><span class="p">,</span> <span class="n">fit_mode</span><span class="o">=</span><span class="s2">&quot;numba_cuda&quot;</span><span class="p">,</span> <span class="n">decision_function_mode</span><span class="o">=</span><span class="s2">&quot;numba_cuda&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">pickle_objects</span><span class="p">(</span><span class="n">FOLDER_CLFS</span> <span class="o">+</span> <span class="n">CLF_NAME</span> <span class="o">+</span> <span class="s2">&quot;.bin&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">clf</span><span class="p">])</span>
        <span class="n">clf</span><span class="o">.</span><span class="n">json_dump</span><span class="p">(</span><span class="n">FOLDER_CLFS</span> <span class="o">+</span> <span class="n">CLF_NAME</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>    
    
    <span class="k">if</span> <span class="n">clf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">MEASURE_ACCS_OF_MODEL</span> <span class="ow">or</span> <span class="n">ADJUST_DECISION_THRESHOLD_OF_MODEL</span> <span class="ow">or</span> <span class="n">DEMO_HAAR_FEATURES_SELECTED</span> <span class="ow">or</span> <span class="n">DEMO_DETECT_IN_VIDEO</span><span class="p">):</span>
        <span class="p">[</span><span class="n">clf</span><span class="p">]</span> <span class="o">=</span> <span class="n">unpickle_objects</span><span class="p">(</span><span class="n">FOLDER_CLFS</span> <span class="o">+</span> <span class="n">CLF_NAME</span> <span class="o">+</span> <span class="s2">&quot;.bin&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[unpickled clf </span><span class="si">{</span><span class="n">clf</span><span class="si">}</span><span class="s2"> with decision threshold: </span><span class="si">{</span><span class="n">clf</span><span class="o">.</span><span class="n">decision_threshold_</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>     
    
    <span class="k">if</span> <span class="n">DEMO_HAAR_FEATURES_SELECTED</span><span class="p">:</span>        
        <span class="n">demo_haar_features</span><span class="p">(</span><span class="n">hinds</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">selected_indexes</span><span class="o">=</span><span class="n">clf</span><span class="o">.</span><span class="n">features_selected_</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">MEASURE_ACCS_OF_MODEL</span><span class="p">:</span>
        <span class="n">measure_accs_of_model</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>            
    
    <span class="k">if</span> <span class="n">ADJUST_DECISION_THRESHOLD_OF_MODEL</span><span class="p">:</span>    
        <span class="n">adjust_decision_threshold_via_precision</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
        <span class="n">pickle_objects</span><span class="p">(</span><span class="n">FOLDER_CLFS</span> <span class="o">+</span> <span class="n">CLF_NAME</span> <span class="o">+</span> <span class="s2">&quot;.bin&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">clf</span><span class="p">])</span>
        <span class="n">clf</span><span class="o">.</span><span class="n">json_dump</span><span class="p">(</span><span class="n">FOLDER_CLFS</span> <span class="o">+</span> <span class="n">CLF_NAME</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>    
    
    <span class="k">if</span> <span class="n">DEMO_DETECT_IN_VIDEO</span><span class="p">:</span>            
        <span class="n">demo_detect_in_video</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">decision_threshold</span><span class="o">=</span><span class="n">DETECTION_DECISION_THRESHOLD</span><span class="p">,</span> <span class="n">computations</span><span class="o">=</span><span class="n">DEMO_DETECT_IN_VIDEO_COMPUTATIONS</span><span class="p">,</span> <span class="n">postprocess</span><span class="o">=</span><span class="n">DETECTION_POSTPROCESS</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">DEMO_DETECT_IN_VIDEO_PARALLEL_JOBS</span><span class="p">,</span> 
                             <span class="n">detector_title</span><span class="o">=</span><span class="n">KIND</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">verbose_loop</span><span class="o">=</span><span class="n">DEMO_DETECT_IN_VIDEO_VERBOSE_LOOP</span><span class="p">,</span> <span class="n">verbose_detect</span><span class="o">=</span><span class="n">DEMO_DETECT_IN_VIDEO_VERBOSE_DETECT</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">DEMO_DETECT_IN_VIDEO_MULTIPLE_CLFS</span><span class="p">:</span>        
        <span class="n">clfs_names</span> <span class="o">=</span> <span class="n">MC_CLFS_NAMES</span>
        <span class="n">decision_thresholds</span> <span class="o">=</span> <span class="n">MC_DECISION_THRESHOLDS</span>
        <span class="n">clfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">unpickle_objects</span><span class="p">(</span><span class="n">FOLDER_CLFS</span> <span class="o">+</span> <span class="n">clf_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">clf_name</span> <span class="ow">in</span> <span class="n">clfs_names</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[about to start multiple clfs demo; unpickled clfs:]&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">clf_name</span><span class="p">,</span> <span class="n">clf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">clfs_names</span><span class="p">,</span> <span class="n">clfs</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">clf_name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">clf</span><span class="si">}</span><span class="s2"> with decision_threshold_: </span><span class="si">{</span><span class="n">clf</span><span class="o">.</span><span class="n">decision_threshold_</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>        
        <span class="n">demo_detect_in_video_multiple_clfs</span><span class="p">(</span><span class="n">clfs</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">,</span> <span class="n">decision_thresholds</span><span class="p">,</span> <span class="n">postprocess</span><span class="o">=</span><span class="n">DETECTION_POSTPROCESS</span><span class="p">,</span> 
                                           <span class="n">detector_title</span><span class="o">=</span><span class="s2">&quot;face, hand&quot;</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">verbose_loop</span><span class="o">=</span><span class="n">DEMO_DETECT_IN_VIDEO_VERBOSE_LOOP</span><span class="p">,</span> <span class="n">verbose_detect</span><span class="o">=</span><span class="n">DEMO_DETECT_IN_VIDEO_VERBOSE_DETECT</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MAIN-DETECTOR DONE.&quot;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Przemysław Klęsk.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>